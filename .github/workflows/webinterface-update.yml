name: Update Webinterface

on:
  workflow_dispatch:
    inputs:
      install_dir:
        description: "Install directory on the target host"
        required: false
        default: "/var/www/easywi"
      ref:
        description: "Git ref or tag to deploy"
        required: false
        default: "Beta"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Update web interface
        shell: bash
        run: |
          set -euo pipefail
          install_dir="${{ inputs.install_dir }}"
          ref="${{ inputs.ref }}"

          if [[ ! -d "${install_dir}" ]]; then
            echo "Install directory ${install_dir} not found." >&2
            exit 1
          fi

          cd "${install_dir}"
          git fetch --all --tags
          git checkout "${ref}"
          git pull --ff-only origin "${ref}"

          if [[ -d core ]]; then
            cd core
          fi

          if command -v composer >/dev/null 2>&1; then
            composer install --no-dev --optimize-autoloader --no-interaction
          fi

          if [[ ! -f vendor/symfony/polyfill-uuid/bootstrap.php ]]; then
            echo "vendor missing symfony/polyfill-uuid, reinstalling" >&2
            rm -rf vendor
            composer install --no-dev --optimize-autoloader --no-interaction
          fi

          if command -v php >/dev/null 2>&1 && [[ -f bin/console ]]; then
            php bin/console doctrine:migrations:migrate --no-interaction || true
            php bin/console cache:clear || true
          fi
