{% set detailMode = detailMode|default(false) %}
{% set templateContext = instance.template ?? {} %}
{% set installResolver = templateContext.install_resolver ?? templateContext.installResolver ?? {} %}
{% set resolverType = installResolver.type ?? '' %}
{% set isMinecraft = resolverType in ['minecraft_vanilla', 'papermc_paper'] %}
{% if detailMode %}
    <form method="post" action="{{ path('customer_instance_settings', {id: instance.id, detail: 1}) }}" class="space-y-4">
{% else %}
    <form class="space-y-4" hx-post="{{ path('customer_instance_settings', {id: instance.id}) }}" hx-target="#instance-card-{{ instance.id }}" hx-swap="outerHTML">
{% endif %}
    <div class="grid gap-4 lg:grid-cols-2">
        <div class="rounded-lg border border-slate-200 bg-white p-4">
            <p class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_update_policy', page_locale()) }}</p>
            <div class="mt-3 space-y-2 text-sm text-slate-600">
                <label class="flex items-center gap-2">
                    <input type="radio" name="update_policy" value="manual" {% if instance.update_policy != 'auto' %}checked{% endif %} class="text-indigo-600">
                    {{ t('customer_instance_policy_manual_only', page_locale()) }}
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="update_policy" value="auto" {% if instance.update_policy == 'auto' %}checked{% endif %} class="text-indigo-600">
                    {{ t('customer_instance_policy_auto_schedule', page_locale()) }}
                </label>
            </div>
            <div class="mt-4 grid gap-3 sm:grid-cols-2">
                <div>
                    <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_cron_schedule', page_locale()) }}</label>
                    <input type="text" name="cron_expression" value="{{ instance.schedule ? instance.schedule.cron_expression : '0 3 * * *' }}" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                    <p class="mt-1 text-xs text-slate-700">{{ t('customer_instance_cron_default', page_locale()) }}</p>
                </div>
                <div>
                    <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_time_zone', page_locale()) }}</label>
                    <input type="text" name="time_zone" value="{{ instance.schedule ? instance.schedule.time_zone : 'UTC' }}" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                </div>
            </div>
        </div>
        <div class="rounded-lg border border-slate-200 bg-white p-4">
            <p class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_version_lock', page_locale()) }}</p>
            {% if isMinecraft and minecraftCatalog is not empty %}
                {% set versionOptions = resolverType == 'minecraft_vanilla' ? minecraftCatalog.vanilla.versions : minecraftCatalog.paper.versions %}
                <div class="mt-4 grid gap-3 sm:grid-cols-2">
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_locked_version', page_locale()) }}</label>
                        <select name="locked_version" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm" data-minecraft-version>
                            <option value="" {% if (instance.locked_version ?? '') == '' %}selected{% endif %}>{{ t('customer_instance_latest_option', page_locale()) }}</option>
                            {% for version in versionOptions %}
                                <option value="{{ version }}" {% if version == (instance.locked_version ?? '') %}selected{% endif %}>{{ version }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if resolverType == 'papermc_paper' %}
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_locked_build_id', page_locale()) }}</label>
                            <select name="locked_build_id" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm" data-minecraft-build>
                                <option value="" {% if (instance.locked_build_id ?? '') == '' %}selected{% endif %}>{{ t('customer_instance_latest_option', page_locale()) }}</option>
                                {% for version, builds in minecraftCatalog.paper.builds %}
                                    {% for build in builds %}
                                        <option value="{{ build }}" data-version="{{ version }}" {% if build == (instance.locked_build_id ?? '') %}selected{% endif %}>
                                            {{ build }} ({{ version }})
                                        </option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                    {% else %}
                        <input type="hidden" name="locked_build_id" value="">
                    {% endif %}
                </div>
                <p class="mt-3 text-xs text-slate-700">{{ t('customer_instance_lock_remove_hint', page_locale()) }}</p>
            {% else %}
                <div class="mt-4 grid gap-3 sm:grid-cols-2">
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_locked_build_id', page_locale()) }}</label>
                        <input type="text" name="locked_build_id" value="{{ instance.locked_build_id ?? '' }}" placeholder="{{ t('customer_instance_locked_build_placeholder', page_locale()) }}" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-700">{{ t('customer_instance_lock_label', page_locale()) }}</label>
                        <input type="text" name="locked_version" value="{{ instance.locked_version ?? '' }}" placeholder="{{ t('customer_instance_lock_label_placeholder', page_locale()) }}" class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                    </div>
                </div>
                <p class="mt-3 text-xs text-slate-700">{{ t('customer_instance_lock_remove_hint', page_locale()) }}</p>
            {% endif %}
        </div>
    </div>
    <div class="flex justify-end">
        <button type="submit" class="rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-800">{{ t('customer_instance_save_update_settings', page_locale()) }}</button>
    </div>
    </form>

{% if isMinecraft and resolverType == 'papermc_paper' %}
    <script>
        (() => {
            const versionSelects = document.querySelectorAll('[data-minecraft-version]');
            versionSelects.forEach((versionSelect) => {
                const form = versionSelect.closest('form');
                const buildSelect = form ? form.querySelector('[data-minecraft-build]') : null;
                if (!buildSelect) {
                    return;
                }

                const updateBuilds = () => {
                    const version = versionSelect.value;
                    const options = Array.from(buildSelect.options);
                    options.forEach((option, index) => {
                        if (index === 0) {
                            option.hidden = false;
                            option.disabled = false;
                            return;
                        }
                        const optionVersion = option.dataset.version || '';
                        const shouldShow = version === '' || optionVersion === version;
                        option.hidden = !shouldShow;
                        option.disabled = !shouldShow;
                    });

                    if (buildSelect.selectedOptions.length > 0 && buildSelect.selectedOptions[0].disabled) {
                        buildSelect.value = '';
                    }
                };

                updateBuilds();
                versionSelect.addEventListener('change', updateBuilds);
            });
        })();
    </script>
{% endif %}
