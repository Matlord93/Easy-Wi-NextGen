{% extends 'customer/base.html.twig' %}

{% block title %}Setup · {{ instance.template.displayName }} · Easy-Wi NextGen{% endblock %}

{% block body %}
<div class="px-4 py-6 sm:px-6 lg:px-8 space-y-6">
    <div class="server-hero" data-instance-id="{{ instance.id }}">
        <div class="server-hero__info">
            <p class="text-xs font-semibold uppercase text-slate-400">{{ instance.template.gameKey }}</p>
            <h1 class="text-2xl font-semibold text-slate-900">{{ instance.template.displayName }}</h1>
            <div class="flex flex-wrap items-center gap-3 text-sm text-slate-600">
                <span class="setup-badge {{ setupStatus.is_ready ? 'setup-ready' : 'setup-warning' }}">
                    {{ setupStatus.is_ready ? 'Setup ready' : 'Setup erforderlich' }}
                </span>
                <span>Server #{{ instance.id }}</span>
            </div>
        </div>
    </div>

    <div class="server-tabs">
        {% for tab in tabs %}
            <a href="{{ tab.href }}" class="server-tab {{ tab.key == 'setup' ? 'is-active' : '' }}">{{ tab.label }}</a>
        {% endfor %}
    </div>

    <div class="server-card">
        <div class="server-card__header">
            <h2 class="text-sm font-semibold text-slate-900">Setup Status</h2>
        </div>
        <div class="server-card__body space-y-3">
            {% if setupStatus.is_ready %}
                <p class="text-sm text-slate-600">Alle Pflichtfelder sind gesetzt. Du kannst den Server installieren und starten.</p>
            {% else %}
                <p class="text-sm text-slate-600">Bitte trage die fehlenden Angaben ein, um den Server nutzen zu können.</p>
                <ul class="list-disc pl-5 text-sm text-slate-600">
                    {% for label in missingLabels %}
                        <li>{{ label }}</li>
                    {% else %}
                        <li>Einige Felder müssen vom Support ergänzt werden.</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    </div>

    <div class="server-card">
        <div class="server-card__header">
            <h2 class="text-sm font-semibold text-slate-900">Installation</h2>
        </div>
        <div class="server-card__body space-y-2 text-sm text-slate-600">
            {% set installMessages = {
                'NODE_NOT_SET': 'Kein Node zugewiesen. Bitte Support kontaktieren.',
                'MISSING_REQUIREMENTS': 'Setup ist noch nicht vollständig.',
                'NO_PORTS_AVAILABLE': 'Keine freien Ports verfügbar.',
                'TEMPLATE_OS_MISMATCH': 'Template unterstützt das Node-Betriebssystem nicht.'
            } %}
            <button type="button" class="btn-primary" data-install-action {{ not installStatus.is_ready ? 'disabled' : '' }}>
                Installieren
            </button>
            <p class="{{ installStatus.is_ready ? 'text-slate-500' : 'text-rose-600' }}" data-install-feedback>
                {{ installStatus.is_ready ? 'Installation startet einen Job im Hintergrund.' : installMessages[installStatus.error_code]|default('Installation aktuell nicht möglich.') }}
            </p>
        </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
        <div class="server-card">
            <div class="server-card__header">
                <h2 class="text-sm font-semibold text-slate-900">Variablen</h2>
            </div>
            <div class="server-card__body">
                {% if messages.vars %}
                    <div class="mb-4 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-700">{{ messages.vars }}</div>
                {% endif %}
                <form action="/kunden/servers/{{ instance.id }}/setup/vars" method="post" class="space-y-4">
                    {% for field in vars %}
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 uppercase">
                                {{ field.label }}{% if field.required %} *{% endif %}
                            </label>
                            <input
                                name="vars[{{ field.key }}]"
                                value="{{ field.value }}"
                                type="{{ field.type == 'number' ? 'number' : 'text' }}"
                                class="mt-2 w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm"
                            >
                            {% if field.helptext %}
                                <p class="mt-1 text-xs text-slate-600">{{ field.helptext }}</p>
                            {% endif %}
                            {% if field.error %}
                                <p class="mt-1 text-xs text-rose-600">{{ field.error }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-sm text-slate-500">Keine Variablen definiert.</p>
                    {% endfor %}
                    <button type="submit" class="btn-primary">Variablen speichern</button>
                </form>
            </div>
        </div>

        <div class="server-card">
            <div class="server-card__header">
                <h2 class="text-sm font-semibold text-slate-900">Secrets</h2>
            </div>
            <div class="server-card__body">
                {% if messages.secrets %}
                    <div class="mb-4 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm text-emerald-700">{{ messages.secrets }}</div>
                {% endif %}
                <form action="/kunden/servers/{{ instance.id }}/setup/secrets" method="post" class="space-y-4">
                    {% for field in secrets %}
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 uppercase">
                                {{ field.label }}{% if field.required %} *{% endif %}
                            </label>
                            <div class="mt-2 flex flex-col gap-2">
                                <input
                                    name="secrets[{{ field.key }}]"
                                    type="{{ field.type == 'number' ? 'number' : 'password' }}"
                                    class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm"
                                    placeholder="Neues Secret eingeben"
                                >
                                <span class="text-xs text-slate-600">Gesetzt: {{ field.is_set ? 'Ja' : 'Nein' }}</span>
                            </div>
                            {% if field.helptext %}
                                <p class="mt-1 text-xs text-slate-600">{{ field.helptext }}</p>
                            {% endif %}
                            {% if field.error %}
                                <p class="mt-1 text-xs text-rose-600">{{ field.error }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-sm text-slate-500">Keine Secrets definiert.</p>
                    {% endfor %}
                    <button type="submit" class="btn-primary">Secrets speichern</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        const installButton = document.querySelector('[data-install-action]');
        const feedback = document.querySelector('[data-install-feedback]');
        if (!installButton || !feedback) {
            return;
        }

        const errorMessages = {
            NODE_NOT_SET: 'Kein Node zugewiesen. Bitte Support kontaktieren.',
            MISSING_REQUIREMENTS: 'Setup ist noch nicht vollständig.',
            NO_PORTS_AVAILABLE: 'Keine freien Ports verfügbar.',
            TEMPLATE_OS_MISMATCH: 'Template unterstützt das Node-Betriebssystem nicht.',
        };

        installButton.addEventListener('click', async () => {
            feedback.textContent = 'Installation wird gestartet...';
            feedback.classList.remove('text-rose-600');
            feedback.classList.add('text-slate-500');

            const response = await fetch(`/api/customer/instances/{{ instance.id }}/actions`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({ action: 'install' }),
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                feedback.textContent = errorMessages[data.error_code] || data.error || 'Installation fehlgeschlagen.';
                feedback.classList.remove('text-slate-500');
                feedback.classList.add('text-rose-600');
                return;
            }

            feedback.textContent = 'Installation wurde gestartet.';
        });
    })();
</script>
{% endblock %}
