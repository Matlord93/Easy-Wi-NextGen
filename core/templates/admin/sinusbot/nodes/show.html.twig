{% extends 'admin/base.html.twig' %}

{% block title %}{{ t('admin_sinusbot_node_title', page_locale())|replace({'%name%': node.name}) }} · Easy-Wi NextGen{% endblock %}

{% block content %}
    <div class="sinusbot-page">
        <div class="sinusbot-header">
            <div>
                <h1>{{ node.name }}</h1>
                <p>{{ t('admin_sinusbot_intro', page_locale()) }}</p>
            </div>
            <div class="sinusbot-actions">
                <a class="sinusbot-link" href="/admin/sinusbot/nodes">{{ t('admin_sinusbot_back_to_overview', page_locale()) }}</a>
                <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/delete" onsubmit="return confirm('SinusBot Node wirklich löschen?');">
                    <input type="hidden" name="_token" value="{{ csrf.delete }}">
                    <button class="sinusbot-button" type="submit">Löschen</button>
                </form>
            </div>
        </div>

        {% for message in app.flashes('success') %}
            <div class="sinusbot-alert sinusbot-alert-success">{{ message }}</div>
        {% endfor %}

        <div class="sinusbot-grid">
            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_installation_title', page_locale()) }}</h2>
                <div class="sinusbot-meta">
                    <div><strong>{{ t('admin_sinusbot_status_label', page_locale()) }}</strong> {{ node.installStatus }}</div>
                    <div><strong>{{ t('admin_sinusbot_version_label', page_locale()) }}</strong> {{ node.installedVersion ?? '–' }}</div>
                    <div><strong>{{ t('admin_sinusbot_last_error_label', page_locale()) }}</strong> {{ node.lastError ?? '–' }}</div>
                </div>
                <div class="sinusbot-actions">
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/install">
                        <input type="hidden" name="_token" value="{{ csrf.install }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_install_repair', page_locale()) }}</button>
                    </form>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/refresh">
                        <input type="hidden" name="_token" value="{{ csrf.refresh }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_refresh_status', page_locale()) }}</button>
                    </form>
                </div>
            </div>

            <div class="sinusbot-card">
                <h2>Letzte Jobs</h2>
                {% if agent_jobs is not empty %}
                    {% for job in agent_jobs %}
                        <div class="sinusbot-meta">
                            <div><strong>Typ:</strong> {{ job.type }}</div>
                            <div><strong>Status:</strong> {{ job.status.value }}</div>
                            <div><strong>Gestartet:</strong> {{ job.startedAt ? job.startedAt|date('Y-m-d H:i') : '—' }}</div>
                            <div><strong>Beendet:</strong> {{ job.finishedAt ? job.finishedAt|date('Y-m-d H:i') : '—' }}</div>
                            <div><strong>Fehler:</strong> {{ job.errorText ?? '—' }}</div>
                        </div>
                        {% if job.logText %}
                            <div class="sinusbot-code"><pre>{{ job.logText }}</pre></div>
                        {% endif %}
                        {% if job.resultPayload %}
                            <div class="sinusbot-code"><pre>{{ job.resultPayload|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre></div>
                        {% endif %}
                        {% if not loop.last %}
                            <p class="sinusbot-muted">—</p>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="sinusbot-muted">Keine Jobs vorhanden.</p>
                {% endif %}
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_ts3_dependency_title', page_locale()) }}</h2>
                <div class="sinusbot-meta">
                    <div><strong>{{ t('admin_sinusbot_installed_label', page_locale()) }}</strong> {{ node.ts3ClientInstalled ? t('admin_sinusbot_yes', page_locale()) : t('admin_sinusbot_no', page_locale()) }}</div>
                    <div><strong>{{ t('admin_sinusbot_version_label', page_locale()) }}</strong> {{ node.ts3ClientVersion ?? '–' }}</div>
                    <div><strong>{{ t('admin_sinusbot_path_label', page_locale()) }}</strong> {{ node.ts3ClientPath ?? '–' }}</div>
                </div>
                <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/install-ts3-client" class="sinusbot-form">
                    <input type="hidden" name="_token" value="{{ csrf.install_ts3_client }}">
                    <label for="ts3-client-url">{{ t('admin_sinusbot_ts3_download_label', page_locale()) }}</label>
                    <input id="ts3-client-url" type="text" name="ts3_client_download_url" placeholder="{{ t('admin_sinusbot_ts3_download_placeholder', page_locale()) }}">
                    <div class="sinusbot-actions">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_ts3_install_repair', page_locale()) }}</button>
                    </div>
                </form>
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_agent_config_title', page_locale()) }}</h2>
                <div class="sinusbot-meta">
                    <div><strong>{{ t('admin_sinusbot_agent_url_label', page_locale()) }}</strong> {{ node.agentBaseUrl }}</div>
                    <div><strong>{{ t('admin_sinusbot_install_path_label', page_locale()) }}</strong> {{ node.installPath }}</div>
                    <div><strong>{{ t('admin_sinusbot_web_bind_label', page_locale()) }}</strong> {{ node.webBindIp }}:{{ node.webPortBase }}</div>
                </div>
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_admin_credentials_title', page_locale()) }}</h2>
                <p class="sinusbot-muted">{{ t('admin_sinusbot_admin_credentials_note', page_locale()) }}</p>
                {% if admin_password %}
                    <div class="sinusbot-credentials">
                        <div><strong>{{ t('admin_sinusbot_username_label', page_locale()) }}</strong> {{ node.adminUsername ?? '–' }}</div>
                        <div class="sinusbot-secret">{{ admin_password }}</div>
                    </div>
                    <button class="sinusbot-button" type="button" data-sinusbot-copy="{{ admin_password }}">{{ t('admin_sinusbot_copy', page_locale()) }}</button>
                {% else %}
                    <div class="sinusbot-credentials">
                        <div><strong>{{ t('admin_sinusbot_username_label', page_locale()) }}</strong> {{ node.adminUsername ?? '–' }}</div>
                        <div class="sinusbot-secret">••••••••</div>
                    </div>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/reveal-credentials">
                        <input type="hidden" name="_token" value="{{ csrf.reveal }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_reveal', page_locale()) }}</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('[data-sinusbot-copy]').forEach(function (button) {
            button.addEventListener('click', function () {
                navigator.clipboard?.writeText(button.dataset.sinusbotCopy || '');
            });
        });
    </script>
{% endblock %}
