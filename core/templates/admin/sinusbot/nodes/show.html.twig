{% extends 'admin/base.html.twig' %}


{% block content %}
    <div class="sinusbot-page">
        <div class="sinusbot-header">
            <div>
                <h1>{{ node.name }}</h1>
                <p>{{ t('admin_sinusbot_intro', page_locale()) }}</p>
            </div>
            <div class="sinusbot-actions">
                <a class="sinusbot-link" href="/admin/sinusbot/nodes">{{ t('admin_sinusbot_back_to_overview', page_locale()) }}</a>
                <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/delete" onsubmit="return confirm('SinusBot Node wirklich löschen?');">
                    <input type="hidden" name="_token" value="{{ csrf.delete }}">
                    <button class="sinusbot-button" type="submit">Löschen</button>
                </form>
            </div>
        </div>

        {% for message in app.flashes('success') %}
            <div class="sinusbot-alert sinusbot-alert-success">{{ message }}</div>
        {% endfor %}

        <div class="sinusbot-grid">
            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_installation_title', page_locale()) }}</h2>
                <div class="sinusbot-meta">
                    <div><strong>{{ t('admin_sinusbot_status_label', page_locale()) }}</strong> {{ node.installStatus }}</div>
                    <div><strong>Runtime:</strong> {{ node.running ? 'running' : 'stopped' }}</div>
                    <div><strong>{{ t('admin_sinusbot_version_label', page_locale()) }}</strong> {{ node.installedVersion ?? '–' }}</div>
                    <div><strong>{{ t('admin_sinusbot_last_error_label', page_locale()) }}</strong> {{ node.lastError ?? '–' }}</div>
                </div>
                <div class="sinusbot-actions">
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/install">
                        <input type="hidden" name="_token" value="{{ csrf.install }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_install_repair', page_locale()) }}</button>
                    </form>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/refresh">
                        <input type="hidden" name="_token" value="{{ csrf.refresh }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_refresh_status', page_locale()) }}</button>
                    </form>
                </div>
                <div class="sinusbot-actions">
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/start">
                        <input type="hidden" name="_token" value="{{ csrf.start }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_start', page_locale()) }}</button>
                    </form>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/stop">
                        <input type="hidden" name="_token" value="{{ csrf.stop }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_stop', page_locale()) }}</button>
                    </form>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/restart">
                        <input type="hidden" name="_token" value="{{ csrf.restart }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_restart', page_locale()) }}</button>
                    </form>
                </div>
            </div>

            <div class="sinusbot-card">
                <h2>Letzte Jobs</h2>
                {% if agent_jobs is not empty %}
                    {% for job in agent_jobs %}
                        <div class="sinusbot-meta">
                            <div><strong>Typ:</strong> {{ job.type }}</div>
                            <div><strong>Status:</strong> {{ job.status.value }}</div>
                            <div><strong>Gestartet:</strong> {{ job.startedAt ? job.startedAt|date('Y-m-d H:i') : '—' }}</div>
                            <div><strong>Beendet:</strong> {{ job.finishedAt ? job.finishedAt|date('Y-m-d H:i') : '—' }}</div>
                            <div><strong>Fehler:</strong> {{ job.errorText ?? '—' }}</div>
                        </div>
                        {% if job.logText %}
                            <div class="sinusbot-code"><pre>{{ job.logText }}</pre></div>
                        {% endif %}
                        {% if job.resultPayload %}
                            <div class="sinusbot-code"><pre>{{ job.resultPayload|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre></div>
                        {% endif %}
                        {% if not loop.last %}
                            <p class="sinusbot-muted">—</p>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="sinusbot-muted">Keine Jobs vorhanden.</p>
                {% endif %}
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_agent_config_title', page_locale()) }}</h2>
                <div class="sinusbot-meta">
                    <div><strong>Zugewiesener Kunde:</strong> {{ node.customer ? node.customer.email : '–' }}</div>
                    <div><strong>{{ t('admin_sinusbot_agent_url_label', page_locale()) }}</strong> {{ node.agentBaseUrl }}</div>
                    <div><strong>{{ t('admin_sinusbot_install_path_label', page_locale()) }}</strong> {{ node.installPath }}</div>
                    <div><strong>{{ t('admin_sinusbot_web_bind_label', page_locale()) }}</strong> {{ node.webBindIp }}:{{ node.webPortBase }}</div>
                    <div><strong>TS3-Client:</strong> {{ node.ts3ClientInstalled ? 'Installiert (Installed)' : 'Nicht installiert (Not installed)' }}</div>
                    <div><strong>TS3-Client Version:</strong> {{ node.ts3ClientVersion ?? '–' }}</div>
                    <div><strong>TS3-Client Pfad:</strong> {{ node.ts3ClientPath ?? '–' }}</div>
                    <div>
                        <strong>Verwaltungs-URL:</strong>
                        {% if management_url %}
                            <a class="sinusbot-link" href="{{ management_url }}" target="_blank" rel="noopener">{{ management_url }}</a>
                        {% else %}
                            –
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_admin_credentials_title', page_locale()) }}</h2>
                <p class="sinusbot-muted">{{ t('admin_sinusbot_admin_credentials_note', page_locale()) }}</p>
                {% if admin_password %}
                    <div class="sinusbot-credentials">
                        <div><strong>{{ t('admin_sinusbot_username_label', page_locale()) }}</strong> {{ node.adminUsername ?? '–' }}</div>
                        <div class="sinusbot-secret">{{ admin_password }}</div>
                    </div>
                    <button class="sinusbot-button" type="button" data-sinusbot-copy="{{ admin_password }}">{{ t('admin_sinusbot_copy', page_locale()) }}</button>
                {% else %}
                    <div class="sinusbot-credentials">
                        <div><strong>{{ t('admin_sinusbot_username_label', page_locale()) }}</strong> {{ node.adminUsername ?? '–' }}</div>
                        <div class="sinusbot-secret">••••••••</div>
                    </div>
                    <form method="post" action="/admin/sinusbot/nodes/{{ node.id }}/reveal-credentials">
                        <input type="hidden" name="_token" value="{{ csrf.reveal }}">
                        <button class="sinusbot-button" type="submit">{{ t('admin_sinusbot_reveal', page_locale()) }}</button>
                    </form>
                {% endif %}
            </div>

            <div class="sinusbot-card">
                <h2>{{ t('admin_sinusbot_user_management_title', page_locale()) }}</h2>
                <p class="sinusbot-muted">{{ t('admin_sinusbot_user_management_description', page_locale()) }}</p>
                <div class="sinusbot-code">
                    <pre>{{ t('admin_sinusbot_user_management_example', page_locale()) }}</pre>
                </div>
                <a class="sinusbot-link" href="https://sinusbot.github.io/api-docs/" target="_blank" rel="noopener">
                    {{ t('admin_sinusbot_user_management_link', page_locale()) }}
                </a>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('[data-sinusbot-copy]').forEach(function (button) {
            button.addEventListener('click', function () {
                navigator.clipboard?.writeText(button.dataset.sinusbotCopy || '');
            });
        });
    </script>
{% endblock %}
