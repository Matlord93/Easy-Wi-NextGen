<div class="p-6 border-b border-slate-200">
    <h2 class="text-lg font-semibold">{{ t('admin_tickets_form_title', page_locale()) }}</h2>
    <p class="text-sm text-slate-500">{{ t('admin_tickets_form_intro', page_locale()) }}</p>
</div>
<form class="p-6 space-y-4" method="post" action="/admin/tickets" hx-post="/admin/tickets" hx-target="#ticket-form" hx-swap="outerHTML">
    {% if form.errors is not empty %}
        <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
            <ul class="list-disc list-inside">
                {% for error in form.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if templates is not empty %}
        <div>
            <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_template_label', page_locale()) }}</label>
            <select id="admin-ticket-template-select" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
                <option value="">{{ t('admin_tickets_template_placeholder', page_locale()) }}</option>
                {% for template in templates %}
                    <option
                        value="{{ template.id }}"
                        data-subject="{{ template.subject|e('html_attr') }}"
                        data-category="{{ template.category }}"
                        data-priority="{{ template.priority }}"
                        data-body="{{ template.body|e('html_attr') }}"
                    >
                        {{ template.title }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <div>
        <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_form_customer', page_locale()) }}</label>
        <select name="customer_id" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="">{{ t('admin_tickets_form_customer_select', page_locale()) }}</option>
            {% for customer in customers %}
                <option value="{{ customer.id }}" {{ form.customer_id == customer.id ? 'selected' : '' }}>{{ customer.email }}</option>
            {% endfor %}
        </select>
    </div>

    <div>
        <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_form_subject', page_locale()) }}</label>
        <input id="admin-ticket-subject" name="subject" value="{{ form.subject }}" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm" placeholder="{{ t('admin_tickets_form_subject_placeholder', page_locale()) }}" />
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_form_category', page_locale()) }}</label>
            <select id="admin-ticket-category" name="category" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
                <option value="general" {{ form.category == 'general' ? 'selected' : '' }}>{{ t('admin_tickets_category_general', page_locale()) }}</option>
                <option value="billing" {{ form.category == 'billing' ? 'selected' : '' }}>{{ t('admin_tickets_category_billing', page_locale()) }}</option>
                <option value="technical" {{ form.category == 'technical' ? 'selected' : '' }}>{{ t('admin_tickets_category_technical', page_locale()) }}</option>
                <option value="abuse" {{ form.category == 'abuse' ? 'selected' : '' }}>{{ t('admin_tickets_category_abuse', page_locale()) }}</option>
            </select>
        </div>
        <div>
            <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_form_priority', page_locale()) }}</label>
            <select id="admin-ticket-priority" name="priority" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
                <option value="low" {{ form.priority == 'low' ? 'selected' : '' }}>{{ t('admin_tickets_priority_low', page_locale()) }}</option>
                <option value="normal" {{ form.priority == 'normal' ? 'selected' : '' }}>{{ t('admin_tickets_priority_normal', page_locale()) }}</option>
                <option value="high" {{ form.priority == 'high' ? 'selected' : '' }}>{{ t('admin_tickets_priority_high', page_locale()) }}</option>
                <option value="urgent" {{ form.priority == 'urgent' ? 'selected' : '' }}>{{ t('admin_tickets_priority_urgent', page_locale()) }}</option>
            </select>
        </div>
    </div>

    <div>
        <label class="text-xs font-semibold uppercase text-slate-500">{{ t('admin_tickets_form_message', page_locale()) }}</label>
        <textarea id="admin-ticket-message" name="message" rows="4" class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm" placeholder="{{ t('admin_tickets_form_message_placeholder', page_locale()) }}">{{ form.message }}</textarea>
    </div>

    {% if adminSignature %}
        <label class="flex items-center gap-2 text-xs text-slate-500">
            <input type="checkbox" name="include_signature" value="1" class="h-4 w-4 rounded border-slate-300 text-indigo-600" {{ form.include_signature ? 'checked' : '' }}>
            {{ t('admin_tickets_signature_toggle', page_locale()) }}
        </label>
    {% endif %}

    <div class="flex items-center justify-end">
        <button type="submit" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-slate-900 text-white">{{ t('admin_tickets_form_submit', page_locale()) }}</button>
    </div>
</form>

{% if templates is not empty %}
    <script>
        (() => {
            const templateSelect = document.getElementById('admin-ticket-template-select');
            const subjectInput = document.getElementById('admin-ticket-subject');
            const categorySelect = document.getElementById('admin-ticket-category');
            const prioritySelect = document.getElementById('admin-ticket-priority');
            const messageTextarea = document.getElementById('admin-ticket-message');

            if (!templateSelect) {
                return;
            }

            templateSelect.addEventListener('change', () => {
                const option = templateSelect.selectedOptions[0];
                if (!option || !option.dataset.subject) {
                    return;
                }

                if (subjectInput) {
                    subjectInput.value = option.dataset.subject || '';
                }
                if (categorySelect) {
                    categorySelect.value = option.dataset.category || '';
                }
                if (prioritySelect) {
                    prioritySelect.value = option.dataset.priority || '';
                }
                if (messageTextarea) {
                    messageTextarea.value = option.dataset.body || '';
                }
            });
        })();
    </script>
{% endif %}
