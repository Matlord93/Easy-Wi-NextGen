{% extends 'admin/base.html.twig' %}


{% block content %}
{% set selectedNode = selectedNode ?? nodes|first %}
{% set statusMap = {
    'online': 'badge--success',
    'stale': 'badge--warning',
    'offline': 'badge--danger',
    'provisioning': 'badge--primary',
    'maintenance': 'badge--neutral'
} %}
<section class="nodes-page">
    <header class="nodes-header">
        <div>
            <h1 class="nodes-title">{{ t('admin_nodes_title', page_locale()) }}</h1>
            <p class="nodes-subtitle">{{ t('admin_nodes_intro', page_locale()) }}</p>
        </div>
        <div class="nodes-actions">
            {% if summary.latestVersion %}
                <span class="badge badge--primary">
                    {{ t('admin_nodes_channel', page_locale())|replace({'%channel%': updateChannel|upper}) }} · {{ summary.latestVersion }}
                </span>
                <span class="badge badge--warning">
                    {{ t('admin_nodes_updates_available', page_locale())|replace({'%count%': summary.updates}) }}
                </span>
            {% else %}
                <span class="badge badge--neutral">
                    {{ t('admin_nodes_release_unavailable', page_locale()) }}
                </span>
            {% endif %}
            <button
                class="btn btn--secondary"
                hx-post="/admin/nodes/update"
                hx-target="#nodes-table-wrap"
                hx-swap="innerHTML"
            >{{ t('admin_nodes_update_agents', page_locale()) }}</button>
            <a href="/admin/nodes/register" class="btn btn--secondary">{{ t('admin_nodes_register_button', page_locale()) }}</a>
            <button
                class="btn btn--primary"
                hx-post="/admin/nodes/provision"
                hx-target="#nodes-table-wrap"
                hx-swap="innerHTML"
                hx-confirm="{{ t('admin_nodes_register', page_locale()) }}"
            >{{ t('admin_nodes_provision', page_locale()) }}</button>
        </div>
    </header>

    {% if diskProtectCount is defined and diskProtectCount > 0 %}
        <div class="nodes-alert nodes-alert--danger">
            {{ t('admin_nodes_disk_protect_banner', page_locale())|replace({'%count%': diskProtectCount}) }}
        </div>
    {% endif %}

    <div class="nodes-summary">
        <div class="nodes-stat">
            <div class="nodes-stat__label">{{ t('admin_nodes_total', page_locale()) }}</div>
            <div class="nodes-stat__value">{{ summary.total }}</div>
        </div>
        <div class="nodes-stat">
            <div class="nodes-stat__label">{{ t('admin_nodes_online', page_locale()) }}</div>
            <div class="nodes-stat__value nodes-stat__value--success">{{ summary.online }}</div>
        </div>
        <div class="nodes-stat">
            <div class="nodes-stat__label">{{ t('admin_nodes_stale', page_locale()) }}</div>
            <div class="nodes-stat__value nodes-stat__value--warning">{{ summary.stale }}</div>
        </div>
        <div class="nodes-stat">
            <div class="nodes-stat__label">{{ t('admin_nodes_offline', page_locale()) }}</div>
            <div class="nodes-stat__value nodes-stat__value--danger">{{ summary.offline }}</div>
        </div>
        <div class="nodes-stat">
            <div class="nodes-stat__label">{{ t('admin_nodes_updates_label', page_locale()) }}</div>
            <div class="nodes-stat__value nodes-stat__value--warning">{{ summary.updates }}</div>
            <div class="nodes-stat__label">{{ summary.latestVersion ?? t('admin_nodes_release_unavailable', page_locale()) }}</div>
        </div>
    </div>

    <div class="nodes-layout">
        <div class="nodes-card">
            <div class="nodes-card__header">
                <div>
                    <h2 class="nodes-card__title">{{ t('admin_nodes_fleet', page_locale()) }}</h2>
                    <p class="nodes-card__subtitle">{{ t('admin_nodes_fleet_intro', page_locale()) }}</p>
                </div>
                <button
                    class="btn btn--tertiary"
                    hx-get="/admin/nodes/table"
                    hx-target="#nodes-table-wrap"
                    hx-swap="innerHTML"
                >{{ t('refresh', page_locale()) }}</button>
            </div>
            <div id="nodes-feedback" class="nodes-feedback"></div>
            <div id="nodes-table-wrap">
                {% include 'admin/nodes/_table.html.twig' with { nodes: nodes, updateChannel: updateChannel } %}
            </div>
        </div>

        <aside class="nodes-card">
            <div class="nodes-detail">
                {% if selectedNode %}
                    <form class="nodes-detail-card" method="get" action="/admin/nodes">
                        <div class="nodes-detail-card__header">
                            <div class="nodes-detail-card__title">{{ t('admin_nodes_select_agent', page_locale()) }}</div>
                        </div>
                        <div class="nodes-form-grid">
                            <div class="form-field">
                                <label class="form-label" for="node-select">{{ t('admin_nodes_select_node_label', page_locale()) }}</label>
                                <select id="node-select" name="node" class="form-input">
                                    {% for node in nodes %}
                                        <option value="{{ node.id }}" {% if node.id == selectedNode.id %}selected{% endif %}>
                                            {{ node.name ?? t('admin_nodes_unnamed', page_locale()) }} ({{ node.id }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-field">
                                <button class="btn btn--secondary" type="submit">{{ t('admin_nodes_load_button', page_locale()) }}</button>
                            </div>
                        </div>
                    </form>

                    {% set statusClass = statusMap[selectedNode.status] ?? 'badge--neutral' %}
                    <div class="nodes-detail__header">
                        <h3 class="nodes-detail__title">{{ selectedNode.name ?? t('admin_nodes_unnamed', page_locale()) }}</h3>
                        <div class="nodes-detail__subline">
                            {{ selectedNode.lastHeartbeatIp ?? '—' }}
                        </div>
                        <div class="nodes-detail__badges">
                            <span class="badge {{ statusClass }}">{{ selectedNode.status|title }}</span>
                            {% if selectedNode.updateAvailable is same as(true) %}
                                <span class="badge badge--warning">{{ t('admin_nodes_update_available', page_locale()) }}</span>
                            {% elseif selectedNode.updateAvailable is same as(false) and selectedNode.lastHeartbeatVersion %}
                                <span class="badge badge--success">{{ t('admin_nodes_up_to_date', page_locale()) }}</span>
                            {% endif %}
                            {% if selectedNode.serverUpdate is not null and selectedNode.serverUpdate.updatesAvailable is same as(true) %}
                                <span class="badge badge--warning">{{ t('admin_nodes_server_updates_available', page_locale()) }}</span>
                            {% elseif selectedNode.serverUpdate is not null and selectedNode.serverUpdate.updatesAvailable is same as(false) %}
                                <span class="badge badge--success">{{ t('admin_nodes_server_updates_current', page_locale()) }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="nodes-detail-grid">
                        <div class="nodes-detail-card">
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">{{ t('status', page_locale()) }}</div>
                                {% if selectedNode.rebootRequired is same as(true) %}
                                    <span class="badge badge--warning">{{ t('admin_nodes_reboot_required', page_locale()) }}</span>
                                {% endif %}
                            </div>
                            <div class="nodes-metadata">
                            <div>
                                <div class="nodes-meta__label">{{ t('admin_nodes_table_last_seen', page_locale()) }}</div>
                                <div class="nodes-meta__value">{{ selectedNode.lastSeenAt ? selectedNode.lastSeenAt|date('Y-m-d H:i') : '—' }}</div>
                            </div>
                            <div>
                                <div class="nodes-meta__label">{{ t('admin_nodes_table_version', page_locale()) }}</div>
                                <div class="nodes-meta__value">{{ selectedNode.lastHeartbeatVersion ?? '—' }}</div>
                            </div>
                            <div>
                                <div class="nodes-meta__label">{{ t('admin_nodes_os_provider', page_locale()) }}</div>
                                <div class="nodes-meta__value">{{ selectedNode.osProvider ?? '—' }}</div>
                            </div>
                            <div>
                                <div class="nodes-meta__label">{{ t('admin_nodes_server_update_status', page_locale()) }}</div>
                                {% if selectedNode.serverUpdate %}
                                    <div class="nodes-meta__value">
                                        {{ selectedNode.serverUpdate.status|title }}
                                        {% if selectedNode.serverUpdate.resultMessage %}
                                            · {{ selectedNode.serverUpdate.resultMessage }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="nodes-meta__value">—</div>
                                {% endif %}
                            </div>
                            </div>
                            <div class="nodes-inline-actions">
                                <button
                                    class="btn btn--tertiary"
                                    hx-post="/admin/nodes/{{ selectedNode.id }}/reboot-check"
                                    hx-target="#nodes-table-wrap"
                                    hx-swap="innerHTML"
                                >{{ t('admin_nodes_reboot_check', page_locale()) }}</button>
                                <button
                                    class="btn btn--tertiary"
                                    hx-post="/admin/nodes/{{ selectedNode.id }}/update-check"
                                    hx-target="#nodes-table-wrap"
                                    hx-swap="innerHTML"
                                >{{ t('admin_nodes_update_check', page_locale()) }}</button>
                                <a class="btn btn--tertiary" href="/admin/nodes/{{ selectedNode.id }}/port-ranges">
                                    {{ t('admin_nodes_port_ranges', page_locale()) }}
                                </a>
                            </div>
                        </div>

                        <div class="nodes-detail-card">
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">{{ t('admin_nodes_services', page_locale()) }}</div>
                            </div>
                            <div class="role-toggle-group">
                                {% if selectedNode.services is empty %}
                                    <span class="text-xs text-slate-500">{{ t('admin_nodes_services_empty', page_locale()) }}</span>
                                {% else %}
                                    {% for service, state in selectedNode.services %}
                                        <span class="role-chip {{ state == 'active' ? 'role-chip--active' : '' }}">{{ service }} · {{ state }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <form
                            class="nodes-detail-card"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/roles"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">{{ t('admin_nodes_roles_section', page_locale()) }}</div>
                                <button class="btn btn--secondary" type="submit">{{ t('admin_nodes_update_roles', page_locale()) }}</button>
                            </div>
                            <div class="role-toggle-group">
                                {% for roleOption in roleOptions %}
                                    {% set roleKey = roleOption|lower %}
                                    <label class="role-toggle">
                                        <input
                                            type="checkbox"
                                            name="roles[]"
                                            value="{{ roleOption }}"
                                            {% if roleKey in selectedNode.roleKeys %}checked{% endif %}
                                            aria-label="{{ roleOption }}"
                                        >
                                        <span>{{ roleOption }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </form>

                        <form
                            class="nodes-detail-card"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/agent-settings"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">Agent (TS/Sinusbot)</div>
                                <button class="btn btn--secondary" type="submit">Speichern</button>
                            </div>
                            <div class="nodes-form-grid">
                                <div class="form-field">
                                    <label class="form-label" for="agent-base-url">Agent Base URL</label>
                                    <input
                                        id="agent-base-url"
                                        name="agent_base_url"
                                        type="text"
                                        value="{{ selectedNode.agent.base_url ?? '' }}"
                                        placeholder="https://agent.example.com"
                                        class="form-input"
                                    >
                                </div>
                                <div class="form-field">
                                    <label class="form-label" for="agent-api-token">Agent API Token</label>
                                    <input
                                        id="agent-api-token"
                                        name="agent_api_token"
                                        type="password"
                                        placeholder="{{ selectedNode.agent.token_configured ? '••••••••' : '' }}"
                                        class="form-input"
                                    >
                                    <p class="text-xs text-slate-500">Token nur ausfüllen, wenn er geändert werden soll.</p>
                                </div>
                                <div class="form-field">
                                    <label class="form-label" for="agent-job-concurrency">Max. parallele Jobs</label>
                                    <input
                                        id="agent-job-concurrency"
                                        name="job_concurrency"
                                        type="number"
                                        min="1"
                                        value="{{ selectedNode.agent.job_concurrency ?? 50 }}"
                                        class="form-input"
                                    >
                                    <p class="text-xs text-slate-500">Legt fest, wie viele Jobs der Agent gleichzeitig ausführen darf.</p>
                                </div>
                                <label class="role-toggle">
                                    <input type="checkbox" name="clear_agent_token" value="1">
                                    <span>Agent-Token löschen</span>
                                </label>
                            </div>
                        </form>

                        <form
                            id="node-settings-form"
                            class="nodes-detail-card"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/disk-settings"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">{{ t('admin_nodes_settings_section', page_locale()) }}</div>
                            </div>
                            <div class="nodes-form-grid">
                            <div class="form-field">
                                <label class="form-label" for="disk_scan_interval_seconds">{{ t('admin_nodes_disk_scan_interval', page_locale()) }}</label>
                                <input
                                    id="disk_scan_interval_seconds"
                                    name="disk_scan_interval_seconds"
                                    type="number"
                                    min="60"
                                    value="{{ selectedNode.disk.scan_interval }}"
                                    class="form-input"
                                >
                            </div>
                            <div class="form-field">
                                <label class="form-label" for="disk_warning_percent">{{ t('admin_nodes_disk_warning_percent', page_locale()) }}</label>
                                <input
                                    id="disk_warning_percent"
                                    name="disk_warning_percent"
                                    type="number"
                                    min="1"
                                    max="99"
                                    value="{{ selectedNode.disk.warning_percent }}"
                                    class="form-input"
                                >
                            </div>
                            <div class="form-field">
                                <label class="form-label" for="disk_hard_block_percent">{{ t('admin_nodes_disk_hard_block_percent', page_locale()) }}</label>
                                <input
                                    id="disk_hard_block_percent"
                                    name="disk_hard_block_percent"
                                    type="number"
                                    min="100"
                                    value="{{ selectedNode.disk.hard_block_percent }}"
                                    class="form-input"
                                >
                            </div>
                            <div class="form-field">
                                <label class="form-label" for="node_disk_protection_threshold_percent">{{ t('admin_nodes_disk_protect_threshold', page_locale()) }}</label>
                                <input
                                    id="node_disk_protection_threshold_percent"
                                    name="node_disk_protection_threshold_percent"
                                    type="number"
                                    min="1"
                                    max="20"
                                    value="{{ selectedNode.disk.protect_threshold }}"
                                    class="form-input"
                                >
                            </div>
                            </div>
                            <button class="btn btn--secondary" type="submit">{{ t('admin_nodes_disk_save', page_locale()) }}</button>
                        </form>

                        <form
                            id="node-override-form"
                            class="nodes-detail-card"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/disk-protection-override"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >
                            <div class="nodes-detail-card__header">
                                <div class="nodes-detail-card__title">{{ t('admin_nodes_override_section', page_locale()) }}</div>
                                <button class="btn btn--tertiary" type="submit">{{ t('admin_nodes_disk_override_apply', page_locale()) }}</button>
                            </div>
                            <div class="nodes-form-grid nodes-form-grid--single">
                                <div class="form-field">
                                    <label class="form-label" for="override_minutes">{{ t('admin_nodes_disk_override_minutes', page_locale()) }}</label>
                                    <input
                                        id="override_minutes"
                                        name="override_minutes"
                                        type="number"
                                        min="0"
                                        class="form-input"
                                        placeholder="0"
                                    >
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="nodes-actions-row">
                        <button
                            class="btn btn--primary"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/update"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >{{ t('admin_nodes_update_agent', page_locale()) }}</button>
                        <button
                            class="btn btn--secondary"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/update-run"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                        >{{ t('admin_nodes_server_update_run', page_locale()) }}</button>
                        <button
                            class="btn btn--danger"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/reboot"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                            hx-confirm="{{ t('admin_nodes_reboot_confirm', page_locale()) }}"
                        >{{ t('admin_nodes_reboot', page_locale()) }}</button>
                        <button
                            class="btn btn--danger"
                            hx-post="/admin/nodes/{{ selectedNode.id }}/delete"
                            hx-target="#nodes-table-wrap"
                            hx-swap="innerHTML"
                            {% if selectedNode.delete is defined and selectedNode.delete.allowed is same as(false) %}
                                disabled
                                title="{{ selectedNode.delete.message }}"
                            {% else %}
                                hx-confirm="{{ t('admin_nodes_delete_confirm', page_locale())|replace({'%name%': selectedNode.name ?? t('admin_nodes_unnamed', page_locale())}) }}"
                            {% endif %}
                        >{{ t('admin_nodes_delete', page_locale()) }}</button>
                    </div>
                {% else %}
                    <div class="nodes-detail__header">
                        <h3 class="nodes-detail__title">{{ t('admin_nodes_empty', page_locale()) }}</h3>
                        <div class="nodes-detail__subline">{{ t('admin_nodes_release_unavailable', page_locale()) }}</div>
                    </div>
                {% endif %}
            </div>
        </aside>
    </div>
</section>
{% endblock %}
