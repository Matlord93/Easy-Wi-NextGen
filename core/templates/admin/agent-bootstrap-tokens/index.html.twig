{% extends 'admin/base.html.twig' %}

{% block title %}{{ t('admin_bootstrap_tokens_title', page_locale()) }} · Easy-Wi NextGen{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-semibold">{{ t('admin_bootstrap_tokens_title', page_locale()) }}</h1>
        <p class="text-sm text-slate-700">{{ t('admin_bootstrap_tokens_intro', page_locale()) }}</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1 space-y-6">
        <div class="rounded-xl border border-slate-200 bg-white p-6">
            <h2 class="text-lg font-semibold text-slate-900">{{ t('admin_bootstrap_tokens_create_title', page_locale()) }}</h2>
            <p class="mt-1 text-sm text-slate-700">{{ t('admin_bootstrap_tokens_create_intro', page_locale()) }}</p>

            {% if errors is not empty %}
                <div class="mt-4 rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                    <ul class="list-disc pl-5">
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if createdToken %}
                <div class="mt-4 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
                    <p class="font-semibold">{{ t('admin_bootstrap_tokens_created', page_locale()) }}</p>
                    <p class="mt-2 break-all font-mono text-xs text-emerald-800">{{ createdToken }}</p>
                    <p class="mt-2 text-xs text-emerald-700">{{ t('admin_bootstrap_tokens_created_hint', page_locale()) }}</p>
                </div>
            {% endif %}

            <form method="post" class="mt-4 space-y-4">
                <div>
                    <label class="text-sm font-medium text-slate-700" for="name">{{ t('admin_bootstrap_tokens_name', page_locale()) }}</label>
                    <input
                        id="name"
                        name="name"
                        type="text"
                        value="{{ form.name }}"
                        placeholder="{{ t('admin_bootstrap_tokens_name_placeholder', page_locale()) }}"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700" for="expires_in">{{ t('admin_bootstrap_tokens_expires', page_locale()) }}</label>
                    <input
                        id="expires_in"
                        name="expires_in"
                        type="number"
                        min="1"
                        max="1440"
                        value="{{ form.expires_in }}"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                    <p class="mt-1 text-xs text-slate-700">{{ t('admin_bootstrap_tokens_expires_hint', page_locale()) }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700" for="bound_cidr">{{ t('admin_bootstrap_tokens_cidr', page_locale()) }}</label>
                    <input
                        id="bound_cidr"
                        name="bound_cidr"
                        type="text"
                        value="{{ form.bound_cidr }}"
                        placeholder="203.0.113.0/24"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                    <p class="mt-1 text-xs text-slate-700">{{ t('admin_bootstrap_tokens_cidr_hint', page_locale()) }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700" for="bound_node_name">{{ t('admin_bootstrap_tokens_node_name', page_locale()) }}</label>
                    <input
                        id="bound_node_name"
                        name="bound_node_name"
                        type="text"
                        value="{{ form.bound_node_name }}"
                        placeholder="node-eu-01"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                    <p class="mt-1 text-xs text-slate-700">{{ t('admin_bootstrap_tokens_node_name_hint', page_locale()) }}</p>
                </div>
                <button class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white">{{ t('admin_bootstrap_tokens_create', page_locale()) }}</button>
            </form>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="rounded-xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900">{{ t('admin_bootstrap_tokens_list', page_locale()) }}</h2>
                    <p class="mt-1 text-sm text-slate-700">{{ t('admin_bootstrap_tokens_list_intro', page_locale()) }}</p>
                    <p class="mt-1 text-xs text-slate-500">{{ t('admin_bootstrap_tokens_recent_hint', page_locale())|replace({'%count%': recentTokenLimit}) }}</p>
                </div>
            </div>

            {% if tokens is empty %}
                <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
                    {{ t('admin_bootstrap_tokens_empty', page_locale()) }}
                </div>
            {% else %}
                <div class="mt-4 overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs uppercase tracking-wide text-slate-500">
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_name', page_locale()) }}</th>
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_prefix', page_locale()) }}</th>
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_constraints', page_locale()) }}</th>
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_expires', page_locale()) }}</th>
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_status', page_locale()) }}</th>
                                <th class="pb-3">{{ t('admin_bootstrap_tokens_table_actions', page_locale()) }}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            {% for token in tokens %}
                                <tr class="text-slate-700">
                                    <td class="py-3 font-medium text-slate-900">
                                        {{ token.name }}
                                        {% if token.usedAt %}
                                            <div class="text-xs text-slate-500">{{ t('admin_bootstrap_tokens_used_at', page_locale())|replace({'%time%': token.usedAt|date('Y-m-d H:i')}) }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 font-mono text-xs">{{ token.prefix }}</td>
                                    <td class="py-3 text-xs">
                                        {% if token.boundCidr %}
                                            <div>{{ t('admin_bootstrap_tokens_bound_cidr', page_locale())|replace({'%cidr%': token.boundCidr}) }}</div>
                                        {% endif %}
                                        {% if token.boundNodeName %}
                                            <div>{{ t('admin_bootstrap_tokens_bound_node', page_locale())|replace({'%node%': token.boundNodeName}) }}</div>
                                        {% endif %}
                                        {% if not token.boundCidr and not token.boundNodeName %}
                                            <span class="text-slate-500">{{ t('admin_bootstrap_tokens_unbound', page_locale()) }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 text-xs">{{ token.expiresAt|date('Y-m-d H:i') }}</td>
                                    <td class="py-3">
                                        {% set statusClass = {
                                            'active': 'bg-emerald-100 text-emerald-700',
                                            'used': 'bg-amber-100 text-amber-700',
                                            'expired': 'bg-slate-200 text-slate-600',
                                            'revoked': 'bg-rose-100 text-rose-700'
                                        } %}
                                        <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-semibold {{ statusClass[token.status] }}">
                                            {{ t('admin_bootstrap_tokens_status_' ~ token.status, page_locale()) }}
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        {% if token.status == 'active' %}
                                            <form method="post" action="/admin/agent-bootstrap-tokens/{{ token.id }}/revoke">
                                                <button class="text-xs font-semibold text-rose-600 hover:text-rose-700">{{ t('admin_bootstrap_tokens_revoke', page_locale()) }}</button>
                                            </form>
                                        {% else %}
                                            <span class="text-xs text-slate-400">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
