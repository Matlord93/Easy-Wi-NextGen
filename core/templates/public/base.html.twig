{% set siteTitle = app_setting('site_title', 'Easy-Wi NextGen') %}
{% set brandingName = app_setting('branding_name', siteTitle) %}
{% set brandingLogo = app_setting('branding_logo_url') %}
<!DOCTYPE html>
<html lang="{{ page_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        (function () {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <title>{{ siteTitle }}</title>
    <link rel="stylesheet" href="{{ asset('ui.css') }}">
    <link rel="stylesheet" href="{{ asset('admin-customer.css') }}">
    <link rel="stylesheet" href="{{ asset('ts6.css') }}">
    <link rel="stylesheet" href="{{ asset('ts3.css') }}">
    <script src="{{ asset('htmx.min.js') }}"></script>
</head>
<body class="bg-slate-100 text-slate-900">
{% set showPortalShell = showPortalShell is defined ? showPortalShell : true %}
{% set contentClass = contentClass is defined ? contentClass : 'mx-auto w-full max-w-6xl px-4 py-6 sm:px-6' %}
{% set currentUser = current_user() %}
{% if showPortalShell %}
{% set activeNav = activeNav|default('') %}
<main class="min-h-screen flex flex-col">
    <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-slate-200 shadow-sm">
            <div class="flex items-center justify-between px-4 py-4 sm:px-6">
                <div class="flex items-center gap-3 w-full"></div>
                <div class="hidden items-center gap-4 sm:flex">
                    <div class="text-right">
                        <p class="text-sm font-semibold">{{ t('hosting_updates_title', page_locale()) }}</p>
                        <p class="text-xs text-slate-700">{{ t('hosting_updates_subtitle', page_locale()) }}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if currentUser %}
                            {% set portalPath = '/dashboard' %}
                            {% set portalLabel = t('customer_portal', page_locale()) %}
                            {% if is_granted('ROLE_ADMIN') %}
                                {% set portalPath = '/admin' %}
                                {% set portalLabel = t('admin_portal', page_locale()) %}
                            {% elseif is_granted('ROLE_RESELLER') %}
                                {% set portalPath = '/reseller/customers' %}
                                {% set portalLabel = t('reseller_portal', page_locale()) %}
                            {% endif %}
                            <a href="{{ portalPath }}" class="btn rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-50">{{ portalLabel }}</a>
                            <a href="{{ path('public_logout') }}" class="btn rounded-lg bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-slate-800">{{ t('logout', page_locale()) }}</a>
                        {% else %}
                            <a href="{{ path('public_login') }}" class="btn rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-50">{{ t('login', page_locale()) }}</a>
                            <a href="{{ path('public_register') }}" class="btn rounded-lg bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-slate-800">{{ t('register', page_locale()) }}</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <section class="{{ contentClass }}">
            {% block content %}{% endblock %}
        </section>

        <footer class="border-t border-slate-200 bg-white">
            <div class="mx-auto flex w-full max-w-6xl flex-col gap-3 px-4 py-6 text-xs text-slate-700 sm:flex-row sm:items-center sm:justify-between sm:px-6">
                <div class="flex flex-col gap-1">
                    <span class="text-[11px] text-slate-500">© {{ "now"|date("Y") }}</span>
                </div>
                <div class="flex flex-wrap gap-4">
                    <a href="{{ path('public_cms_page_slug', {slug: 'impressum'}) }}" class="hover:text-slate-700">{{ t('imprint', page_locale()) }}</a>
                    <a href="{{ path('public_cms_page_slug', {slug: 'agb'}) }}" class="hover:text-slate-700">{{ t('terms_of_service', page_locale()) }}</a>
                    <a href="{{ path('public_cms_page_slug', {slug: 'datenschutz'}) }}" class="hover:text-slate-700">{{ t('privacy_policy', page_locale()) }}</a>
                    <button type="button" class="hover:text-slate-700" data-cookie-open>{{ t('cookie_settings', page_locale()) }}</button>
                </div>
            </div>
        </footer>
    </main>
{% else %}
<main class="min-h-screen flex flex-col">
    <section class="{{ contentClass }}">
        {{ block('content') }}
    </section>
    <footer class="mt-auto border-t border-slate-200 bg-white">
        <div class="mx-auto flex w-full max-w-6xl flex-col gap-3 px-4 py-6 text-xs text-slate-700 sm:flex-row sm:items-center sm:justify-between sm:px-6">
            <div class="flex flex-col gap-1">
                <span class="text-[11px] text-slate-500">© {{ "now"|date("Y") }}</span>
            </div>
            <div class="flex flex-wrap gap-4">
                <a href="{{ path('public_cms_page_slug', {slug: 'impressum'}) }}" class="hover:text-slate-700">{{ t('imprint', page_locale()) }}</a>
                <a href="{{ path('public_cms_page_slug', {slug: 'agb'}) }}" class="hover:text-slate-700">{{ t('terms_of_service', page_locale()) }}</a>
                <a href="{{ path('public_cms_page_slug', {slug: 'datenschutz'}) }}" class="hover:text-slate-700">{{ t('privacy_policy', page_locale()) }}</a>
                <button type="button" class="hover:text-slate-700" data-cookie-open>{{ t('cookie_settings', page_locale()) }}</button>
            </div>
        </div>
    </footer>
</main>
{% endif %}

<div id="cookie-banner" class="fixed inset-x-4 bottom-4 z-40 hidden rounded-2xl border border-slate-200 bg-white p-4 shadow-lg sm:inset-x-auto sm:right-6 sm:max-w-lg">
    <div class="flex flex-col gap-4">
        <div>
            <h2 class="text-sm font-semibold text-slate-900">{{ t('cookie_banner_title', page_locale()) }}</h2>
            <p class="mt-2 text-xs text-slate-600">{{ t('cookie_banner_description', page_locale()) }}</p>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end">
            <button class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50" data-cookie-reject>{{ t('cookie_reject_optional', page_locale()) }}</button>
            <button class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" data-cookie-settings>{{ t('cookie_settings', page_locale()) }}</button>
            <button class="rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800" data-cookie-accept>{{ t('cookie_accept_all', page_locale()) }}</button>
        </div>
    </div>
</div>

<div id="cookie-settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 px-4 py-6">
    <div class="w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-6 shadow-xl">
        <div class="flex items-start justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold">{{ t('cookie_settings_title', page_locale()) }}</h2>
                <p class="mt-2 text-sm text-slate-600">{{ t('cookie_settings_description', page_locale()) }}</p>
            </div>
            <button type="button" class="text-xs font-semibold text-slate-700 hover:text-slate-700" data-cookie-close>{{ t('cookie_settings_close', page_locale()) }}</button>
        </div>

        <div class="mt-6 space-y-4">
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                <div>
                    <p class="text-sm font-semibold">{{ t('cookie_category_essential', page_locale()) }}</p>
                    <p class="text-xs text-slate-700">{{ t('cookie_purpose_session', page_locale()) }}</p>
                </div>
                <input type="checkbox" checked disabled class="h-4 w-4 rounded border-slate-300 text-slate-700">
            </div>
            <label class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3">
                <div>
                    <p class="text-sm font-semibold">{{ t('cookie_category_functional', page_locale()) }}</p>
                    <p class="text-xs text-slate-700">{{ t('cookie_purpose_language', page_locale()) }}</p>
                </div>
                <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600" data-cookie-toggle="functional">
            </label>
            <label class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3">
                <div>
                    <p class="text-sm font-semibold">{{ t('cookie_category_analytics', page_locale()) }}</p>
                    <p class="text-xs text-slate-700">—</p>
                </div>
                <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600" data-cookie-toggle="analytics">
            </label>
            <label class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3">
                <div>
                    <p class="text-sm font-semibold">{{ t('cookie_category_marketing', page_locale()) }}</p>
                    <p class="text-xs text-slate-700">—</p>
                </div>
                <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600" data-cookie-toggle="marketing">
            </label>
        </div>

        <div class="mt-6 overflow-hidden rounded-xl border border-slate-200">
            <table class="min-w-full text-xs">
                <thead class="bg-slate-50 text-left text-slate-700">
                    <tr>
                        <th class="px-4 py-2">{{ t('cookie_cookie_name', page_locale()) }}</th>
                        <th class="px-4 py-2">{{ t('cookie_cookie_purpose', page_locale()) }}</th>
                        <th class="px-4 py-2">{{ t('cookie_cookie_duration', page_locale()) }}</th>
                        <th class="px-4 py-2">{{ t('cookie_cookie_type', page_locale()) }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <tr>
                        <td class="px-4 py-2">easywi_session</td>
                        <td class="px-4 py-2">{{ t('cookie_purpose_session', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_duration_session', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_category_essential', page_locale()) }}</td>
                    </tr>
                    <tr>
                        <td class="px-4 py-2">portal_language</td>
                        <td class="px-4 py-2">{{ t('cookie_purpose_language', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_duration_1year', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_category_functional', page_locale()) }}</td>
                    </tr>
                    <tr>
                        <td class="px-4 py-2">cookie_preferences</td>
                        <td class="px-4 py-2">{{ t('cookie_purpose_preferences', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_duration_1year', page_locale()) }}</td>
                        <td class="px-4 py-2">{{ t('cookie_category_functional', page_locale()) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:justify-end">
            <button class="rounded-lg border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50" data-cookie-close>{{ t('cookie_settings_close', page_locale()) }}</button>
            <button class="rounded-lg bg-indigo-600 px-4 py-2 text-xs font-semibold text-white hover:bg-indigo-700" data-cookie-save>{{ t('cookie_settings_save', page_locale()) }}</button>
        </div>
    </div>
</div>

<script>
    const cookieKey = 'cookie_preferences';
    const defaultPrefs = {
        essential: true,
        functional: true,
        analytics: false,
        marketing: false,
    };

    const banner = document.getElementById('cookie-banner');
    const modal = document.getElementById('cookie-settings-modal');
    const toggles = Array.from(document.querySelectorAll('[data-cookie-toggle]'));

    const getCookie = (name) => {
        return document.cookie
            .split('; ')
            .find((row) => row.startsWith(name + '='))
            ?.split('=')[1];
    };

    const setCookie = (name, value) => {
        const encodedValue = encodeURIComponent(value);
        const secureFlag = window.location.protocol === 'https:' ? '; secure' : '';
        document.cookie = `${name}=${encodedValue}; path=/; max-age=31536000; samesite=lax${secureFlag}`;
    };

    const readPreferences = () => {
        const stored = getCookie(cookieKey);
        if (!stored) {
            return null;
        }

        try {
            return JSON.parse(decodeURIComponent(stored));
        } catch (error) {
            return null;
        }
    };

    const writePreferences = (prefs) => {
        setCookie(cookieKey, JSON.stringify(prefs));
    };

    const applyPreferencesToForm = (prefs) => {
        toggles.forEach((toggle) => {
            const key = toggle.dataset.cookieToggle;
            toggle.checked = Boolean(prefs?.[key]);
        });
    };

    const showBannerIfNeeded = () => {
        const prefs = readPreferences();
        if (!prefs && banner) {
            banner.classList.remove('hidden');
        }
    };

    const openModal = () => {
        const prefs = readPreferences() ?? defaultPrefs;
        applyPreferencesToForm(prefs);
        modal?.classList.remove('hidden');
        modal?.classList.add('flex');
    };

    const closeModal = () => {
        modal?.classList.add('hidden');
        modal?.classList.remove('flex');
    };

    document.querySelectorAll('[data-cookie-open]').forEach((button) => {
        button.addEventListener('click', openModal);
    });

    document.querySelectorAll('[data-cookie-settings]').forEach((button) => {
        button.addEventListener('click', () => {
            banner?.classList.add('hidden');
            openModal();
        });
    });

    document.querySelectorAll('[data-cookie-close]').forEach((button) => {
        button.addEventListener('click', closeModal);
    });

    document.querySelectorAll('[data-cookie-accept]').forEach((button) => {
        button.addEventListener('click', () => {
            writePreferences({ ...defaultPrefs, functional: true, analytics: true, marketing: true });
            banner?.classList.add('hidden');
        });
    });

    document.querySelectorAll('[data-cookie-reject]').forEach((button) => {
        button.addEventListener('click', () => {
            writePreferences({ ...defaultPrefs, functional: false, analytics: false, marketing: false });
            banner?.classList.add('hidden');
        });
    });

    document.querySelectorAll('[data-cookie-save]').forEach((button) => {
        button.addEventListener('click', () => {
            const prefs = {
                essential: true,
                functional: toggles.find((toggle) => toggle.dataset.cookieToggle === 'functional')?.checked ?? false,
                analytics: toggles.find((toggle) => toggle.dataset.cookieToggle === 'analytics')?.checked ?? false,
                marketing: toggles.find((toggle) => toggle.dataset.cookieToggle === 'marketing')?.checked ?? false,
            };

            writePreferences(prefs);
            closeModal();
            banner?.classList.add('hidden');
        });
    });

    showBannerIfNeeded();
</script>
</body>
</html>
